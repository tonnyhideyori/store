//this is for router configuration

const express = require("express")
const {
    Product,
    validate
} = require("../models/product")
const authManager = require("../middleware/auth")
const router = express.Router()

router.get("/api/product", async (req, res) => {
    let products = await Product.find().sort("name")
    if(!products){
        res.status(404).send("No product yet in your Store. Please add product !")
        return
    }
    res.send(products)
})
/*router.get("/", async (req, res) => {
    res.send("this is home") //i will use res.redirect("/")- for front end-react
})*/
router.get("/api/product/:id", async (req, res) => {
    try {
        const product = await Product.findById(req.params.id)
        res.send(product)
    } catch (err) {
        res.status(404).send("the given item isn't found")
    }
})
router.post("/api/product", authManager, async (req, res) => {
    const {
        error
    } = validate(req.body)
    if (error) {
        //400 bad request
        res.status(400).send(error.details[0].message)
        return
    }
    let product = new Product({
        name: req.body.name,
        category: req.body.category,
        quantity: req.body.quantity,
        price: req.body.price
    })
    await product.save()
    product = await Product.find().sort("name")
    res.send(product)

})
router.put("/api/product", authManager, async (req, res) => {
    const {
        error
    } = validate(req.body)
    if (error) return res.status(400).send(error.details[0].message)
    try {
        await Product.findByIdAndUpdate(req.body.id, {
            $set: {
                name: req.body.name,
                category: req.body.category,
                quantity: req.body.quantity,
                price: req.body.price,
                dateUpdated:Date.now()
            }
        }, {
            new: true
        })
        const products = await Product.find().sort("name")
        res.send(products)
    } catch (err) {
        res.status(404).send("the given item isn't found")
    }
})
router.delete("/api/product/:id", authManager, async (req, res) => {
    const product = await Product.findByIdAndRemove(req.params.id)
    if (!product) return res.status(404).send("the given item isn't found")
    const products = await Product.find().sort("name")
    res.send(products)
})

module.exports = router